<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ベルトコンベアー型モグラたたき</title>
    <style>
        /* CSS (デザイン) - 主要な変更点 */
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;

            /* 背景画像の追加 (芝生テクスチャ) */
            background-image: url('https://www.transparenttextures.com/patterns/green-dust-and-scratches.png'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: repeat; 
            background-color: #a3c1ad; 
        }

        h1 { 
            color: #fff;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
        
        #controls, #game-info { 
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 20px; 
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #difficulty-select {
            padding: 8px 15px;
            font-size: 1.1em;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        #start-button {
            padding: 10px 25px;
            font-size: 1.5em;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #start-button:hover { background-color: #45a049; transform: translateY(-2px); }
        #start-button:disabled { background-color: #cccccc; cursor: not-allowed; transform: translateY(0); box-shadow: none; }

        #game-info p { margin: 0; color: #333; }
        #score, #time-left { font-weight: bold; color: #d35400; }

        /* ---------------------------------- */
        /* ★★★ コンベアー関連のスタイル ★★★ */
        /* ---------------------------------- */

        #grid {
            /* グリッド全体をコンベアーのフレームに見立てる */
            width: 420px; 
            height: 600px; /* 縦長にする */
            margin: 0 auto;
            background-color: #999; /* コンベアーの色 */
            border: 15px solid #666; /* コンベアーの端 */
            border-radius: 10px;
            padding: 0;
            overflow: hidden; /* 流れる要素を隠す */
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        #conveyor-track {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* 流れてくる行 */
        .row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            width: 100%;
            height: 140px; /* 3つのモグラの穴が入る縦幅 */
            position: absolute;
            top: -140px; /* 画面外上部からスタート */
            left: 0;
            border-bottom: 5px solid #777; /* 行の区切り */
            background-color: #b0c4de; /* 流れるベルトの色 */
            transition: transform linear; /* JSで行時間に合わせて調整 */
        }
        
        /* 穴 (コンベアー上のモグラの台座) */
        .hole {
            background-color: transparent; /* 背景なし */
            overflow: visible; 
            position: relative;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: flex-end; /* モグラが下部から出るように */
            border: none;
            box-shadow: none;
        }

        /* モグラ本体 */
        .mole {
            width: 100px; 
            height: 100px;
            background-color: #c28b5e; 
            border: 4px solid #8b4513; 
            border-radius: 50%;
            position: absolute;
            bottom: 20px; /* 行の底から少し浮かせる */
            transition: none; /* コンベアー式ではアニメーションさせない */
            pointer-events: auto; /* クリック可能 */
            z-index: 2; 
            /* モグラの顔のデザイン (省略) - 縦横比は維持 */
        }

        /* コンベアー式ではモグラが常に出ている状態 */
        .row .mole {
            bottom: 20px; 
            pointer-events: auto; 
        }

        /* ---------------------------------- */
        /* モグラの顔のデザイン (既存 - 簡略化) */
        /* ---------------------------------- */
        .mole:not(.gold):not(.bomb):not(.clock) { background-color: #c28b5e; border-color: #8b4513; }
        .mole.gold { background: linear-gradient(to bottom, #ffd700, #daa520); border: 4px solid #b8860b; }
        .mole.bomb { background-color: #333; border: 4px solid #ff4500; }
        .mole.clock { background-color: #4682b4; border: 4px solid #3cb371; }
        /* 縦横サイズを固定 */
        .face-container {
            width: 100%; 
            height: 100%; 
            padding-top: 15%; 
        }
        /* ... (その他のモグラのパーツCSSは既存のまま) ... */

        /* ---------------------------------- */
        /* スコアポップアップの調整 */
        /* ---------------------------------- */
        .score-pop {
            position: absolute;
            top: -30px; /* モグラの上からポップアップ */
            left: 50%;
            transform: translate(-50%, 0);
            font-size: 2.5em;
            z-index: 10;
            /* アニメーションは既存のものを流用 */
        }

        /* ゲームオーバーモーダル (既存 - 省略) */
        #game-over-modal {
            display: none; 
            position: fixed;
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(5px); 
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto; 
            padding: 30px;
            border: 5px solid #d35400;
            width: 80%;
            max-width: 400px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.5s;
        }

        /* スコアポップアップのアニメーション定義 (既存) */
        @keyframes scorePopUp {
            0% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -100px); }
        }

        /* ---------------------------------- */
        /* その他のモグラパーツCSS (長いため省略 - 既存コードを流用) */
        /* ---------------------------------- */
        .mole:not(.gold):not(.bomb):not(.clock) .paw { background-color: #a0522d; border-color: #8b4513; }
        .mole:not(.gold):not(.bomb):not(.clock) .cheeks { background-color: #ffb6c1; }
        .mole:not(.gold):not(.bomb):not(.clock) .whiskers::before, .mole:not(.gold):not(.bomb):not(.clock) .whiskers::after { background: #8b4513; box-shadow: 0 -6px 0 0 #8b4513, 0 6px 0 0 #8b4513;}

        .mole.gold .paw { background-color: #ffd700; border-color: #b8860b; }
        .mole.gold .cheeks { background-color: #ffcc00; }
        .mole.gold .whiskers::before, .mole.gold .whiskers::after { background: #b8860b; box-shadow: 0 -6px 0 0 #b8860b, 0 6px 0 0 #b8860b; }
        .mole.gold .eye { border-color: #b8860b; }
        .mole.gold .nose { background-color: #f08080; border-color: #8b0000; }
        .mole.gold .nose::after { color: #8b0000; }

        .mole.bomb .paw { background-color: #000; border-color: #ff4500; }
        .mole.bomb .cheeks { background-color: #ff0000; }
        .mole.bomb .whiskers::before, .mole.bomb .whiskers::after { background: #ff4500; box-shadow: 0 -6px 0 0 #ff4500, 0 6px 0 0 #ff4500; }
        .mole.bomb .eye { background-color: #ff0000; border-color: #8b0000; }
        .mole.bomb .eye::before { background-color: #fff; }
        .mole.bomb .eye::after { display: none; }
        .mole.bomb .nose { background-color: #000; border-color: #666; }
        .mole.bomb .nose::after { content: '-'; color: #ff0000; } 
        .mole.bomb .paw::before { background: radial-gradient(#ff0000 30%, transparent 30%); }

        .mole.clock .paw { background-color: #3cb371; border-color: #4682b4; }
        .mole.clock .cheeks { background-color: #90ee90; }
        .mole.clock .whiskers::before, .mole.clock .whiskers::after { background: #3cb371; box-shadow: 0 -6px 0 0 #3cb371, 0 6px 0 0 #3cb371; }
        .mole.clock .eye { border-color: #008000; }
        .mole.clock .eye::before { background-color: #006400; }
        .mole.clock .nose { background-color: #e0ffff; border-color: #4682b4; }
        .mole.clock .nose::after { color: #008000; }
        
    </style>
</head>
<body>
    <h1>ベルトコンベアー モグラたたき！ </h1>

    <div id="game-info">
        <p>スコア: <span id="score">0</span> | 時間: <span id="time-left">30</span>秒</p>
    </div>

    <div id="controls">
        <label for="difficulty-select">難易度: </label>
        <select id="difficulty-select">
            <option value="easy">かんたん</option>
            <option value="normal" selected>ふつう</option>
            <option value="hard">むずかしい</option>
        </select>
        <button id="start-button">ゲームスタート</button>
    </div>

    <div id="grid">
        <div id="conveyor-track">
            </div>
    </div>
        
    <div id="game-over-modal">
        <div class="modal-content">
            <h2>ゲームオーバー！</h2>
            <p>最終スコア</p>
            <span id="final-score" class="final-score">0</span>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <script>
        // JavaScript (ゲームロジック) - 主要な変更点

        const COLUMNS = 3; // 列数
        const ROW_HEIGHT = 140; // CSSと同期 (px)
        const TRACK_HEIGHT = 600; // CSSと同期 (#grid の高さ px)
        const GAME_DURATION = 30; 
        
        const NORMAL_MOLE_SCORE = 1;
        const GOLD_MOLE_SCORE = 3;
        const BOMB_MOLE_SCORE = -5;
        const CLOCK_MOLE_SCORE = 2;

        const BOMB_TIME_PENALTY = 5; 
        const CLOCK_TIME_BONUS = 5; 

        const GOLD_MOLE_CHANCE = 0.10; 
        const BOMB_MOLE_CHANCE = 0.15; 
        const CLOCK_MOLE_CHANCE = 0.05; 
        
        // 難易度ごとのゲームパラメータ (流れる速度と行の出現間隔)
        const DIFFICULTY_SETTINGS = {
            easy: {
                rowDuration: 5500, // 行が上から下まで流れる時間 (ms) - 長い
                rowInterval: 1200, // 新しい行が出現する間隔 (ms) - 長い
            },
            normal: {
                rowDuration: 4000,
                rowInterval: 1000,
            },
            hard: {
                rowDuration: 2500, // 短いほど速い
                rowInterval: 800, // 短いほど頻繁
            }
        };

        let currentRowDuration = DIFFICULTY_SETTINGS.normal.rowDuration;
        let currentRowInterval = DIFFICULTY_SETTINGS.normal.rowInterval;

        let score = 0;
        let timeLeft = GAME_DURATION; 
        let isGameRunning = false;
        let countdownTimerId;
        let rowIntervalId;
        let rowCounter = 0;

        const scoreDisplay = document.getElementById('score');
        const timeLeftDisplay = document.getElementById('time-left');
        const startButton = document.getElementById('start-button');
        const conveyorTrack = document.getElementById('conveyor-track'); // IDを修正
        const gameOverModal = document.getElementById('game-over-modal');
        const finalScoreDisplay = document.getElementById('final-score');
        const difficultySelect = document.getElementById('difficulty-select');

        // -----------------------------------------------------
        // 1. モグラの行生成ロジック
        // -----------------------------------------------------

        function randomMoleType() {
            const r = Math.random();
            if (r < CLOCK_MOLE_CHANCE) { return 'clock'; } 
            else if (r < CLOCK_MOLE_CHANCE + BOMB_MOLE_CHANCE) { return 'bomb'; } 
            else if (r < CLOCK_MOLE_CHANCE + BOMB_MOLE_CHANCE + GOLD_MOLE_CHANCE) { return 'gold'; } 
            else { return 'normal'; }
        }

        function createMoleRow() {
            if (!isGameRunning) return;

            const row = document.createElement('div');
            row.classList.add('row');
            row.dataset.id = rowCounter++;

            // CSSアニメーションのプロパティを設定
            row.style.transitionDuration = `${currentRowDuration}ms`;
            // 画面外からスタート位置(TRACK_HEIGHT)まで移動
            row.style.transform = `translateY(${TRACK_HEIGHT + ROW_HEIGHT}px)`;

            // 行が画面外に出たときの処理を設定
            setTimeout(() => {
                handleRowExit(row);
            }, currentRowDuration); 
            
            // 行の内部にモグラをランダムに配置
            for (let i = 0; i < COLUMNS; i++) {
                const hole = document.createElement('div');
                hole.classList.add('hole');

                // 確率でモグラを出現させる (約70%の確率で空き)
                if (Math.random() > 0.3) { 
                    const mole = document.createElement('div');
                    const moleType = randomMoleType();
                    
                    mole.classList.add('mole', moleType);
                    
                    let scoreValue;
                    switch (moleType) {
                        case 'gold': scoreValue = GOLD_MOLE_SCORE; break;
                        case 'bomb': scoreValue = BOMB_MOLE_SCORE; break;
                        case 'clock': scoreValue = CLOCK_MOLE_SCORE; break;
                        default: scoreValue = NORMAL_MOLE_SCORE; break;
                    }

                    mole.dataset.type = moleType; 
                    mole.dataset.score = scoreValue;
                    mole.dataset.whacked = 'false'; // 叩かれたかどうかのフラグ
                    
                    // モグラの顔のデザインを挿入
                    mole.innerHTML = `
                        <div class="face-container">
                            <div class="eyes">
                                <div class="eye"></div>
                                <div class="eye"></div>
                            </div>
                            <div class="whiskers"></div> <div class="nose"></div>
                            <div class="cheeks cheek left"></div>
                            <div class="cheeks cheek right"></div>
                        </div>
                        <div class="paws">
                            <div class="paw left"></div>
                            <div class="paw right"></div>
                        </div>
                    `;

                    mole.addEventListener('click', whack);
                    hole.appendChild(mole);
                }

                row.appendChild(hole);
            }
            
            conveyorTrack.appendChild(row);

            // アニメーションを即座に開始させるため、次のフレームでtransformをリセット
            requestAnimationFrame(() => {
                 row.style.transform = `translateY(0px)`;
            });
        }
        
        // -----------------------------------------------------
        // 2. プレイヤーの操作ロジック
        // -----------------------------------------------------

        function showScorePop(element, points) {
            const pop = document.createElement('div');
            pop.classList.add('score-pop');
            
            let sign = points > 0 ? '+' : '';
            pop.textContent = sign + points;
            
            if (points > 0) {
                pop.style.color = points >= GOLD_MOLE_SCORE ? '#ffd700' : '#27ae60'; 
            } else {
                pop.style.color = '#e74c3c'; 
            }
            
            element.closest('.hole').appendChild(pop);
            
            setTimeout(() => {
                pop.remove();
            }, 600); 
        }
        
        function whack(event) {
            if (!isGameRunning) return;
            const mole = event.currentTarget;
            
            // 既に叩かれているモグラは無視
            if (mole.dataset.whacked === 'true') return;
            
            mole.dataset.whacked = 'true';
            
            const points = parseInt(mole.dataset.score);
            const type = mole.dataset.type;
            
            showScorePop(mole, points);

            score += points;
            scoreDisplay.textContent = score;

            if (type === 'clock') { 
                timeLeft += CLOCK_TIME_BONUS; 
            } else if (type === 'bomb') { 
                timeLeft -= BOMB_TIME_PENALTY;
            }

            updateTime(); 
            
            // 叩かれたモグラは消える
            mole.style.opacity = '0';
            mole.style.pointerEvents = 'none';
        }
        
        // -----------------------------------------------------
        // 3. 行が画面外に出たときの処理（ミス判定）
        // -----------------------------------------------------
        function handleRowExit(row) {
            if (!isGameRunning) return;

            const missedMoles = row.querySelectorAll('.mole:not(.bomb)');
            
            missedMoles.forEach(mole => {
                // 叩かれず、かつボムでないモグラが行の最後まで流れたらミス
                if (mole.dataset.whacked === 'false') {
                    // ミスによるペナルティ
                    score -= NORMAL_MOLE_SCORE;
                    if (score < 0) score = 0; // スコアがマイナスにならないように
                    scoreDisplay.textContent = score;
                    
                    // ミスしたモグラに特別なポップアップを表示
                    showScorePop(mole, -1);
                }
            });

            // 行をDOMから削除
            row.remove();
        }


        // -----------------------------------------------------
        // 4. ゲームの流れ
        // -----------------------------------------------------

        function updateTime() {
            if (timeLeft < 0) { timeLeft = 0; }
            timeLeftDisplay.textContent = timeLeft;
            if (timeLeft <= 0 && isGameRunning) { endGame(); }
        }

        function startGame() {
            if (isGameRunning) return;
            isGameRunning = true;
            score = 0;
            rowCounter = 0; // 行カウンターをリセット
            
            // 選択された難易度を取得し、パラメータを更新
            const difficulty = difficultySelect.value;
            const settings = DIFFICULTY_SETTINGS[difficulty];
            
            currentRowDuration = settings.rowDuration;
            currentRowInterval = settings.rowInterval;
            
            timeLeft = GAME_DURATION; 
            
            scoreDisplay.textContent = score;
            timeLeftDisplay.textContent = timeLeft;
            startButton.disabled = true;
            gameOverModal.style.display = 'none'; 
            
            // 行生成を周期的に開始
            rowIntervalId = setInterval(createMoleRow, currentRowInterval);
            // ゲームの制限時間を開始
            countdownTimerId = setInterval(countdown, 1000);
            
            // 初回即時生成
            createMoleRow(); 
        }

        function countdown() {
            timeLeft--;
            updateTime();
        }

        function endGame() {
            isGameRunning = false;
            clearInterval(countdownTimerId);
            clearInterval(rowIntervalId);

            // 残っている行をすべて削除
            conveyorTrack.innerHTML = '';

            startButton.disabled = false;
            
            finalScoreDisplay.textContent = score;
            gameOverModal.style.display = 'flex'; 
        }
        
        function closeModal() {
            gameOverModal.style.display = 'none';
        }

        // 初期設定とイベントリスナー
        // 以前の createHoles() の代わりに、初期化時はトラックを空にする
        conveyorTrack.innerHTML = ''; 
        startButton.addEventListener('click', startGame);
    </script>
</body>
</html>
