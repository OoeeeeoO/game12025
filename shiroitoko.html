<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>タワー積みゲーム（自動落下）</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        canvas {
            border: 2px solid #333;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <script>
        // Matter.jsのエイリアス
        var Engine = Matter.Engine,
            Render = Matter.Render,
            Runner = Matter.Runner,
            Bodies = Matter.Bodies,
            Composite = Matter.Composite;

        // --- 設定値 ---
        var width = 600;
        var height = 800;
        var autoDropInterval = 1500; // ブロックが自動で落ちてくる間隔（ミリ秒）。1500ms = 1.5秒

        // 1. エンジンとレンダラーの設定
        var engine = Engine.create();
        var render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: width,
                height: height,
                wireframes: false,
                background: '#fafafa'
            }
        });

        // 2. 地面と壁の作成
        var ground = Bodies.rectangle(width / 2, height, width, 50, { 
            isStatic: true, 
            render: { fillStyle: '#666' }
        });
        var wallL = Bodies.rectangle(-25, height / 2, 50, height, { isStatic: true, render: { fillStyle: '#666' } });
        var wallR = Bodies.rectangle(width + 25, height / 2, 50, height, { isStatic: true, render: { fillStyle: '#666' } });
        
        // 3. 全てのオブジェクトをワールドに追加
        Composite.add(engine.world, [ground, wallL, wallR]);

        // 4. 実行処理
        Render.run(render);
        var runner = Runner.create();
        Runner.run(runner, engine);

        // --- ゲームの主要ロジック ---

        // ブロックを生成する関数
        function createRandomBlock(x, y) {
            // ランダムなサイズ
            var sizeW = Math.random() * 50 + 40; // 40〜90
            var sizeH = Math.random() * 50 + 40; // 40〜90
            
            // ランダムな色
            var color = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');

            var block = Bodies.rectangle(x, y, sizeW, sizeH, {
                restitution: 0.1, // 反発係数を低くして安定性を上げる
                density: 0.001,   
                friction: 0.8,    
                render: {
                    fillStyle: color,
                    strokeStyle: 'black',
                    lineWidth: 1
                }
            });

            Composite.add(engine.world, block);
            return block;
        }

        // 5. ブロックの自動生成とキー操作による制御

        var currentBlock = null; // 現在プレイヤーが操作中のブロック

        function dropNewBlock() {
            // ブロックを画面上部中央付近のランダムなX座標に生成
            var x = width / 2 + (Math.random() - 0.5) * 100;
            currentBlock = createRandomBlock(x, 50); 
        }

        // 初期ブロックをドロップ
        dropNewBlock();

        // 一定間隔で新しいブロックをドロップ
        setInterval(dropNewBlock, autoDropInterval);

        // キーイベントで現在操作中のブロックを動かす
        document.addEventListener('keydown', function(event) {
            if (!currentBlock) return;

            var currentPosition = currentBlock.position;
            var forceMagnitude = 0.05; // 適用する力の大きさ

            switch (event.code) {
                case 'ArrowLeft': // 左矢印キー
                    // 左に移動（力を加える）
                    Matter.Body.applyForce(currentBlock, currentPosition, { x: -forceMagnitude, y: 0 });
                    break;
                case 'ArrowRight': // 右矢印キー
                    // 右に移動（力を加える）
                    Matter.Body.applyForce(currentBlock, currentPosition, { x: forceMagnitude, y: 0 });
                    break;
                case 'ArrowUp': // 上矢印キー（回転）
                    // 少し回転させる
                    Matter.Body.setAngularVelocity(currentBlock, 0.15);
                    break;
                case 'Space': // スペースキー（即時落下）
                    // 落下速度を加速させる（重力方向への力を大きくする）
                    Matter.Body.applyForce(currentBlock, currentPosition, { x: 0, y: 0.1 });
                    break;
            }
        });

        // 6. ブロックの固定判定（ここでは実装を簡略化）
        // ブロックが他のブロックや地面と接触した瞬間に、操作対象から外す（次のブロックを落とす準備）
        // Matter.jsの衝突イベントを使って、ブロックが静止した後のロジックを組むと、より高度なゲームになります。

    </script>
</body>
</html>
